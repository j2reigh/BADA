import { Solar } from "lunar-typescript";

// 1. Korean Mappings
const TEN_GODS_MAP: Record<string, string> = {
  "比肩": "비견", "劫財": "겁재",
  "食神": "식신", "傷官": "상관",
  "偏財": "편재", "正財": "정재",
  "七殺": "편관", "正官": "정관",
  "偏印": "편인", "正印": "정인"
};

const ELEMENTS_MAP: Record<string, string> = {
  "木": "wood", "火": "fire", "土": "earth", "金": "metal", "水": "water"
};

interface PillarData {
  gan: string;
  ganElement: string;
  ganGod: string;
  zhi: string;
  zhiElement: string;
  zhiGod: string;
}

interface SajuResult {
  fourPillars: {
    year: PillarData;
    month: PillarData;
    day: PillarData;
    hour: PillarData;
  };
  elementCounts: {
    wood: number; fire: number; earth: number; metal: number; water: number;
  };
}

export const calculateSaju = (dateStr: string, timeStr: string): SajuResult => {
  try {
    const [year, month, day] = dateStr.split("-").map(Number);
    const [hour, minute] = timeStr.split(":").map(Number);

    // 1. Create Solar & Lunar objects
    const solar = Solar.fromYmdHms(year, month, day, hour, minute, 0);
    const lunar = solar.getLunar();
    
    // 2. Get 'EightChar' (BaZi logic handler)
    // This automatically handles Jeolgi (Solar Terms) for correct Year/Month pillars
    const eightChar = lunar.getEightChar();
    
    // Set Sect to 2 (Standard Modern Saju - starts year at Ipchun, starts day at Midnight)
    eightChar.setSect(2); 

    // Helper to extract data for a pillar
    const getPillarData = (
      gan: string, 
      zhi: string, 
      ganGodChinese: string, 
      zhiGodChinese: string
    ): PillarData => {
      // Use library's built-in WuXing (Five Element) check
      // Note: We need to create a temporary Lunar object or look up the char, 
      // but simpler is to use a direct element map if not available.
      // However, lunar-typescript chars usually have .getWuXing() if wrapped.
      // For simplicity here, we stick to the output chars which are strings.
      
      return {
        gan,
        ganElement: getElement(gan),
        ganGod: TEN_GODS_MAP[ganGodChinese] || ganGodChinese,
        zhi,
        zhiElement: getElement(zhi),
        zhiGod: TEN_GODS_MAP[zhiGodChinese] || zhiGodChinese
      };
    };

    // 3. Build Result
    const result = {
      fourPillars: {
        year: getPillarData(
          eightChar.getYearGan(), 
          eightChar.getYearZhi(), 
          eightChar.getYearShiShenGan(), 
          eightChar.getYearShiShenZhi()
        ),
        month: getPillarData(
          eightChar.getMonthGan(), 
          eightChar.getMonthZhi(), 
          eightChar.getMonthShiShenGan(), 
          eightChar.getMonthShiShenZhi()
        ),
        day: getPillarData(
          eightChar.getDayGan(), 
          eightChar.getDayZhi(), 
          "비견", // Day Gan is Self
          eightChar.getDayShiShenZhi()
        ),
        hour: getPillarData(
          eightChar.getTimeGan(), 
          eightChar.getTimeZhi(), 
          eightChar.getTimeShiShenGan(), 
          eightChar.getTimeShiShenZhi()
        ),
      },
      elementCounts: { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 }
    };

    // 4. Calculate Element Counts
    const allElements = [
      result.fourPillars.year.ganElement, result.fourPillars.year.zhiElement,
      result.fourPillars.month.ganElement, result.fourPillars.month.zhiElement,
      result.fourPillars.day.ganElement, result.fourPillars.day.zhiElement,
      result.fourPillars.hour.ganElement, result.fourPillars.hour.zhiElement,
    ];

    allElements.forEach(el => {
      if (el && result.elementCounts[el as keyof typeof result.elementCounts] !== undefined) {
        result.elementCounts[el as keyof typeof result.elementCounts]++;
      }
    });

    return result;

  } catch (error) {
    console.error("Saju Calculation Error:", error);
    throw new Error("Calculation Failed");
  }
};

// Helper: Simple Element Lookup
const getElement = (char: string): string => {
  const WOOD = ["甲", "乙", "寅", "卯"];
  const FIRE = ["丙", "丁", "巳", "午"];
  const EARTH = ["戊", "己", "辰", "戌", "丑", "未"];
  const METAL = ["庚", "辛", "申", "酉"];
  const WATER = ["壬", "癸", "亥", "子"];

  if (WOOD.includes(char)) return "wood";
  if (FIRE.includes(char)) return "fire";
  if (EARTH.includes(char)) return "earth";
  if (METAL.includes(char)) return "metal";
  if (WATER.includes(char)) return "water";
  return "unknown";
};